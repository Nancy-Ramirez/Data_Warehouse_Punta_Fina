
================================================================================
üöÄ ETL COMPLETO - PUNTAFINA DATA WAREHOUSE
================================================================================

üìã PASO 1: Limpiando tablas afectadas...
--------------------------------------------------------------------------------
   üóëÔ∏è  Truncando dim_impuestos...
      ‚úì dim_impuestos limpiada
   üóëÔ∏è  Truncando dim_promocion...
      ‚úì dim_promocion limpiada
   üóëÔ∏è  Truncando fact_ventas...
      ‚úì fact_ventas limpiada
   ‚úÖ Limpieza completada exitosamente

üìã PASO 2: Verificando estructura de tablas...
--------------------------------------------------------------------------------
   ‚ûï Agregando columna sk_promocion a fact_ventas...
      ‚úì Columna sk_promocion agregada
   ‚úÖ Estructura verificada

üìã PASO 3: Ejecutando ETL principal...
--------------------------------------------------------------------------------
2026-01-09 00:08:48,872 - ETLOrchestrator - INFO - üöÄ Orquestador ETL inicializado
2026-01-09 00:08:48,872 - ETLOrchestrator - INFO - ================================================================================
2026-01-09 00:08:48,872 - ETLOrchestrator - INFO - üè™ PUNTAFINA ETL BATCH - PROCESO COMPLETO
2026-01-09 00:08:48,872 - ETLOrchestrator - INFO - ================================================================================
2026-01-09 00:08:48,872 - ETLOrchestrator - INFO - 
üîì FASE -1: DESBLOQUEO FORZADO DE TABLAS
2026-01-09 00:08:49,218 - ETLOrchestrator - INFO -    üí• Terminando conexiones idle...
2026-01-09 00:08:49,309 - ETLOrchestrator - INFO -    ‚è±Ô∏è  Cancelando queries largas...
2026-01-09 00:08:49,359 - ETLOrchestrator - INFO -    üîí Liberando locks de tablas...
2026-01-09 00:08:49,455 - ETLOrchestrator - INFO -    ‚úÖ Desbloqueo forzado completado
2026-01-09 00:08:49,455 - ETLOrchestrator - INFO - 
üì• FASE 1: EXTRACCI√ìN
2026-01-09 00:08:49,455 - ETLOrchestrator - INFO -    üìä Verificando fuentes de datos disponibles...
2026-01-09 00:08:49,455 - ETLOrchestrator - INFO -    ‚úì orocommerce: oro_customer, oro_order, oro_product, oro_order_line_item
2026-01-09 00:08:49,456 - ETLOrchestrator - INFO -    ‚úì oro_crm: orocrm_channel
2026-01-09 00:08:49,458 - ETLOrchestrator - INFO -    ‚úì 24 archivos CSV en data/inputs/
2026-01-09 00:08:49,458 - ETLOrchestrator - INFO - 
   ‚úÖ Fuentes verificadas: ~877,005 registros disponibles
2026-01-09 00:08:49,458 - ETLOrchestrator - INFO - 
üîÑ FASE 2: TRANSFORMACI√ìN - DIMENSIONES
2026-01-09 00:08:49,458 - ETLOrchestrator - INFO -    üî® Construyendo dimensiones con CompleteDimensionBuilder...
2026-01-09 00:08:50,147 - ETLOrchestrator - ERROR -    ‚ùå Error construyendo dimensiones: DatabaseLoader.__init__() missing 1 required positional argument: 'config'
2026-01-09 00:08:50,148 - ETLOrchestrator - INFO - 
üîÑ FASE 3: TRANSFORMACI√ìN - TABLAS DE HECHOS
2026-01-09 00:08:50,148 - ETLOrchestrator - INFO -    üèóÔ∏è  Cargando facts directamente desde origen...
2026-01-09 00:09:45,439 - ETLOrchestrator - INFO - ================================================================================
CARGANDO TODOS LOS FACTS DESDE ORIGEN
================================================================================

Creando mapeos de dimensiones...
  ‚úÖ 4,018 fechas

üì¶ FACT_INVENTARIO...
   58,397 movimientos en CSV
   58,397 registros v√°lidos
   ‚úÖ 58,397 registros insertados

üíº FACT_TRANSACCIONES...
   2 transacciones en CSV (procesando sample de 50K)...
   0 registros v√°lidos
   ‚úÖ 0 registros insertados

üìä FACT_BALANCE...
   18 registros en CSV
   18 registros v√°lidos
   ‚úÖ 18 registros insertados

üìà FACT_ESTADO_RESULTADOS...
   15 registros en CSV
   15 registros v√°lidos
   ‚úÖ 15 registros insertados

üí∞ FACT_VENTAS...
   Llamando script especializado...
   ‚ö†Ô∏è  Error en carga: Traceback (most recent call last):
  File "/Users/elsalvador/project/PuntaFina_DW_Oro/cargar_fact_ventas.py", line 190, in <module>
    cargar_fact_ventas()
    ~~~~~~~~~~~~~~~~~~^^
  File "/Users/elsalvador/project/PuntaFina_DW_Oro/cargar_fact_ventas.py", line 167, in cargar_fact_ventas
    execute_values(cursor_dw, insert_query, registros, page_size=1000)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/lib/python3.13/site-packages/psycopg2/extras.py", line 1299, in execute_values
    cur.execute(b''.join(parts))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^
psycopg2.errors.ForeignKeyViolation: insert or update on table "fact_ventas" violates foreign key constraint "fact_ventas_impuesto_id_fkey"
DETAIL:  Key (impuesto_id)=(1) is not present in table "dim_impuestos".



================================================================================
‚úÖ TODOS LOS FACTS CARGADOS CORRECTAMENTE
================================================================================

2026-01-09 00:09:45,871 - ETLOrchestrator - INFO -    üîÑ fact_ventas vac√≠o, recargando...
2026-01-09 00:09:49,806 - ETLOrchestrator - INFO -       ‚úì fact_ventas: 0 registros
2026-01-09 00:09:49,859 - ETLOrchestrator - INFO -       ‚úì fact_inventario: 58,397 registros
2026-01-09 00:09:50,028 - ETLOrchestrator - INFO -       ‚úì fact_transacciones: 577,640 registros
2026-01-09 00:09:50,073 - ETLOrchestrator - INFO -       ‚úì fact_balance: 18 registros
2026-01-09 00:09:50,118 - ETLOrchestrator - INFO -       ‚úì fact_estado_resultados: 15 registros
2026-01-09 00:09:50,119 - ETLOrchestrator - INFO - 
   ‚úÖ Facts completadas: 636,070 registros totales
2026-01-09 00:09:50,119 - ETLOrchestrator - INFO - 
üì§ FASE 4: CARGA
2026-01-09 00:09:50,120 - ETLOrchestrator - INFO -    ‚ÑπÔ∏è  La carga se realiz√≥ directamente en las fases anteriores
2026-01-09 00:09:50,120 - ETLOrchestrator - INFO -    ‚ÑπÔ∏è  Los datos ya est√°n en la base de datos datawarehouse_bi
2026-01-09 00:09:51,066 - ETLOrchestrator - WARNING -       ‚ö†Ô∏è  dim_periodo: relation "dim_periodo" does not exist
LINE 1: SELECT COUNT(*) FROM dim_periodo
                             ^

2026-01-09 00:09:51,479 - ETLOrchestrator - INFO - 
   ‚úÖ Verificaci√≥n completada: 702,563 registros totales en DW
2026-01-09 00:09:51,480 - ETLOrchestrator - INFO - 
‚úÖ FASE 5: VALIDACI√ìN FINAL
2026-01-09 00:09:51,480 - ETLOrchestrator - INFO -    üîç Verificando integridad de datos...
2026-01-09 00:09:51,931 - ETLOrchestrator - INFO -       ‚úì dim_fecha: 4,018 registros
2026-01-09 00:09:51,982 - ETLOrchestrator - INFO -       ‚úì dim_cliente: 20,155 registros
2026-01-09 00:09:52,026 - ETLOrchestrator - INFO -       ‚úì dim_producto: 64 registros
2026-01-09 00:09:52,081 - ETLOrchestrator - INFO -       ‚úì dim_orden: 42,119 registros
2026-01-09 00:09:52,127 - ETLOrchestrator - INFO -       ‚úì dim_almacen: 6 registros
2026-01-09 00:09:52,170 - ETLOrchestrator - INFO -       ‚úì dim_proveedor: 8 registros
2026-01-09 00:09:52,218 - ETLOrchestrator - INFO -       ‚úì dim_tipo_movimiento: 9 registros
2026-01-09 00:09:52,269 - ETLOrchestrator - INFO -       ‚úì dim_centro_costo: 9 registros
2026-01-09 00:09:52,315 - ETLOrchestrator - INFO -       ‚úì dim_tipo_transaccion: 9 registros
2026-01-09 00:09:52,357 - ETLOrchestrator - INFO -       ‚úó dim_promocion: 0 registros
2026-01-09 00:09:52,403 - ETLOrchestrator - INFO -       ‚ö†Ô∏è fact_ventas: 0 registros
2026-01-09 00:09:52,459 - ETLOrchestrator - INFO -       ‚úì fact_inventario: 58,397 registros
2026-01-09 00:09:52,626 - ETLOrchestrator - INFO -       ‚úì fact_transacciones: 577,640 registros
2026-01-09 00:09:52,627 - ETLOrchestrator - INFO - 
      ‚úì Total en DW: 702,434 registros
2026-01-09 00:09:52,627 - ETLOrchestrator - INFO -       ‚úì Integridad verificada
2026-01-09 00:09:52,628 - ETLOrchestrator - INFO - 
================================================================================
2026-01-09 00:09:52,628 - ETLOrchestrator - INFO - üìä RESUMEN FINAL DEL PROCESO ETL
2026-01-09 00:09:52,628 - ETLOrchestrator - INFO - ================================================================================
2026-01-09 00:09:52,628 - ETLOrchestrator - INFO - 
‚è±Ô∏è  Tiempo total: 63.75 segundos
2026-01-09 00:09:52,628 - ETLOrchestrator - INFO - ‚úÖ Estado: success
2026-01-09 00:09:52,628 - ETLOrchestrator - INFO - 
üì• Extracci√≥n:
2026-01-09 00:09:52,628 - ETLOrchestrator - INFO -    Total registros: 877,005
2026-01-09 00:09:52,629 - ETLOrchestrator - INFO - 
üîÑ Transformaci√≥n:
2026-01-09 00:09:52,629 - ETLOrchestrator - INFO -    Dimensiones: 0
2026-01-09 00:09:52,629 - ETLOrchestrator - INFO -    Facts: 5
2026-01-09 00:09:52,629 - ETLOrchestrator - INFO -    Total registros: 636,070
2026-01-09 00:09:52,629 - ETLOrchestrator - INFO - 
üì§ Carga:
2026-01-09 00:09:52,629 - ETLOrchestrator - INFO -    Tablas: 18
2026-01-09 00:09:52,629 - ETLOrchestrator - INFO -    Total registros: 702,563
2026-01-09 00:09:52,629 - ETLOrchestrator - WARNING - 
‚ö†Ô∏è  Errores encontrados:
2026-01-09 00:09:52,629 - ETLOrchestrator - WARNING -    {'error': "DatabaseLoader.__init__() missing 1 required positional argument: 'config'"}
2026-01-09 00:09:52,629 - ETLOrchestrator - INFO - 
================================================================================


üìã PASO 4: Verificaci√≥n final de resultados...
--------------------------------------------------------------------------------

   üìä dim_impuestos: 0 registros
      C√≥digos: None
      ‚ö†Ô∏è  ADVERTENCIA: Se esperaban 3 registros, se encontraron 0

   ‚ùå Error en verificaci√≥n: column "id_promocion_source" does not exist
LINE 1: SELECT COUNT(*), MIN(id_promocion_source), MAX(id_promocion_...
                             ^

